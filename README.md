# Helix-Wireless

[Helix](https://github.com/MakotoKurauchi/helix)に[BL652-breakout](https://github.com/ogatatsu/BL652-breakout)
を載せてワイヤレスに改造した物。

## 仕組み
以下の図のようにマスター、スレーブ、PC間で通信する。
![1](./images/1.jpg)

スイッチ１つ１つに一意なIDが振られていて、スレーブマスター間では押されたスイッチのIDを通信でやり取りする、
マスター側では受け取ったスレーブ側で押されたIDと自分側で押されたIDをキーマップからキーコードに変換してPCに送る。
キーマップはマスター側で持っているのでキー配列を変更する時はマスター側のプログラムを変更が必要となる。

![3](./images/3.jpg)

## ビルド方法
- BL652-breakoutには予めFeather nRF52のブートローダーを書き込んでおく。

  参考URL
  
  https://learn.adafruit.com/bluefruit-nrf52-feather-learning-guide/flashing-the-bootloader
  https://qiita.com/ogatatsu@github/items/37f4888c885c4e287df1

- BL652-breakoutを右側、左側共にHelix PCBの白枠線内とは逆の方に刺す。(画像の赤い方)
  ![2](./images/2.jpg)

- ArduinoをインストールしてボードマネージャーからFeather nRF52用の物をインストールしておく。

  参考URL

  https://learn.adafruit.com/bluefruit-nrf52-feather-learning-guide/arduino-bsp-setup

- ArduinoのライブラリマネージャからBounce2ライブラリをインストールする。
- Arduino IDEで.inoファイルを開いて右側のボードにはSlave用のファームウェア、左側にはMaster用のファームウェアを書き込む。

## キーカスタマイズ
キーのカスタマイズはマスター側のソースの`keymap.cpp`ファイルを書き換えることでできる。

通常の入力時のカスタマイズは`keymap[]`配列を変更する。

```c++
static Key keymap[] = {
    {1, L(NK(_GRAVE), CK(_SHIFT, _GRAVE), NK(_GRAVE))},
    {2, L(NK(_1), CK(_SHIFT, _1), NK(_1))},
    {3, L(NK(_2), CK(_SHIFT, _2), NK(_2))},
    {4, L(NK(_3), CK(_SHIFT, _3), NK(_3))},
    {5, L(NK(_4), CK(_SHIFT, _4), NK(_4))},
    ...
```

左側の数字は仕組みで説明した一意なID、右側の関数呼び出しはファームウェア内でコマンドと呼ばれる物でこれの組み合わせを変更することでIDを割り当てられたスイッチを押したときの挙動を変更できる。

どのスイッチが何番のIDに割り当てられているかは以下となる。

```
/* ID
   * ,-----------------------------------------.             ,-----------------------------------------.
   * |   1  |   2  |   3  |   4  |   5  |   6  |             |   7  |   8  |   9  |  10  |  11  |  12  |
   * |------+------+------+------+------+------|             |------+------+------+------+------+------|
   * |  13  |  14  |  15  |  16  |  17  |  18  |             |  19  |  20  |  21  |  22  |  23  |  24  |
   * |------+------+------+------+------+------|             |------+------+------+------+------+------|
   * |  25  |  26  |  27  |  28  |  29  |  30  |             |  31  |  32  |  33  |  34  |  35  |  36  |
   * |------+------+------+------+------+------+------+------+------+------+------+------+------+------|
   * |  37  |  38  |  39  |  40  |  41  |  42  |  43  |  44  |  45  |  46  |  47  |  48  |  49  |  50  |
   * |------+------+------+------+------+------+------+------+------+------+------+------+------+------|
   * |  51  |  52  |  53  |  54  |  55  |  56  |  57  |  58  |  59  |  60  |  61  |  62  |  63  |  64  |
   * `-------------------------------------------------------------------------------------------------'
   */
```

## コマンド一覧
### NOPコマンド
何もしないコマンド、以下の例ではID1のスイッチを押しても何も起こらない。
```c++
static Key keymap[] = {
    {1, NOP},
}
```

### NKコマンド
```c++
NK(uint8_t keycode)
```
通常キー用のコマンド、以下の例では1のスイッチはA,2はB,3はCのキーコードを送出する。
(`keycode.h`ファイルにキーコードに対して`_A`などの名前が割り当てられているのでそちらも参照のこと。)
```c++
static Key keymap[] = {
    {1, NK(_A)},
    {2, NK(_B)},
    {3, NK(_C)},
}
```

### MOコマンド
```c++
MO(Modifier modifier)
```
修飾キー用のコマンド、以下の例では1のスイッチはSHIFTのキーコードを、2のスイッチはCTRLとSHIFTのキーコードを同時に送出する。
修飾キーは`|`演算子で同時押しの組み合わせを表現できる。
```c++
static Key keymap[] = {
    {1, MO(_SHIFT)},
    {2, MO(_CTRL | _SHIFT)},
}
```

### CKコマンド
```c++
CK(Modifier modifier, uint8_t keycode)
```
コンビネーションキー用のコマンド、修飾キーと通常キーの同時押しを表現できる。以下の例は1のスイッチは`CTRL+C`、2のスイッチは`CTRL+ALT+DELETE`のキーコードを送出する。
```c++
static Key keymap[] = {
    {1, CK(_CTRL, _C)},
    {2, CK(_CTRL | _ALT, _DELETE)},
}
```
